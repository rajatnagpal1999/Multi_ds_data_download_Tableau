<!-- Tableau Extension: Multi-Data-Source Multi-Select Multi-Field Filter -->
<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <script src="https://cdn.jsdelivr.net/npm/@tableau/extensions-api@1.10.0/lib/tableau.extensions.1.10.0.min.js"></script>
  <script src="multisource.js"></script>
  <title>Multi-Select Multi-Field Filter</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { display: block; margin-bottom: 8px; }
    select { width: 250px; height: 100px; }
  </style>
</head>
<body>
  <h2>Multi-Source Multi-Field Multi-Select Filter</h2>

  <label>Select Category:
    <select id="categorySelect" multiple></select>
  </label>

  <label>Select Region:
    <select id="regionSelect" multiple></select>
  </label>

  <label>Select Segment:
    <select id="segmentSelect" multiple></select>
  </label>

  <button id="applyBtn">Apply Filters</button>
</body>
</html>

<!-- multisource.js -->
<script>
let worksheets = [];

async function init() {
  await tableau.extensions.initializeAsync();
  const dashboard = tableau.extensions.dashboardContent.dashboard;
  worksheets = dashboard.worksheets;

  const firstSheet = worksheets[0];
  const summary = await firstSheet.getSummaryDataAsync();

  populateDropdown(summary, 'Category', 'categorySelect');
  populateDropdown(summary, 'Region', 'regionSelect');
  populateDropdown(summary, 'Segment', 'segmentSelect');

  document.getElementById('applyBtn').addEventListener('click', applyFilters);
}

tableau.extensions.initializeAsync().then(init);

function populateDropdown(summary, fieldName, elementId) {
  const colIndex = summary.columns.findIndex(c => c.fieldName === fieldName);
  if (colIndex === -1) return;
  const uniqueValues = [...new Set(summary.data.map(row => row[colIndex].value))];
  const dropdown = document.getElementById(elementId);
  uniqueValues.forEach(v => {
    const opt = document.createElement('option');
    opt.textContent = v;
    opt.value = v;
    dropdown.appendChild(opt);
  });
}

function getSelectedValues(elementId) {
  return Array.from(document.getElementById(elementId).selectedOptions).map(o => o.value);
}

async function applyFilters() {
  const filters = [
    { field: 'Category', values: getSelectedValues('categorySelect') },
    { field: 'Region', values: getSelectedValues('regionSelect') },
    { field: 'Segment', values: getSelectedValues('segmentSelect') }
  ];

  for (const ws of worksheets) {
    for (const f of filters) {
      if (f.values.length === 0) continue; // skip empty
      try {
        await ws.applyFilterAsync(f.field, f.values, tableau.FilterUpdateType.REPLACE);
      } catch (err) {
        console.warn(`Filter failed on ${ws.name} for field ${f.field}:`, err);
      }
    }
  }
}
</script>

<!-- extension.trex -->
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns="http://tableau.com/xml/extension_manifest" version="1.0">
  <extension id="multisource-multiselect-filter" extension-version="1.2.0" name="Multi-Select Multi-Source Filter" author="ChatGPT">
    <description>Apply multi-select multi-field filters across multiple worksheets and data sources.</description>
    <min-supporting-version>2021.1</min-supporting-version>
    <source-location>
      <url>index.html</url>
    </source-location>
    <permissions>
      <permission>full data</permission>
    </permissions>
  </extension>
</manifest>
